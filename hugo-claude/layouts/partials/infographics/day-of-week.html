{{ $data := .Site.Data.metrics }}

<section class="relative py-20 px-4 bg-gradient-to-b from-transparent to-deep-space/50">
  <div class="container mx-auto max-w-6xl">

    <h2 class="text-3xl md:text-4xl font-heading font-bold text-center mb-4 text-starlight">
      Тепловая Карта <span class="text-gradient-management">Активности</span>
    </h2>
    <p class="text-center text-slate-400 mb-16 max-w-2xl mx-auto">
      Когда команда онлайн? Анализ по дням недели.
    </p>

    <!-- Chart Container -->
    <div class="relative">
      <canvas id="day-of-week-chart" style="max-height: 350px;"></canvas>
    </div>

    <!-- Insight -->
    <div class="mt-12 max-w-3xl mx-auto p-6 bento-card border-l-4 border-management-orange-start">
      <p class="text-slate-300 leading-relaxed">
        <strong class="text-starlight">Понедельник – главный день активности.</strong>
        22% всех сообщений приходится на начало недели. Выходные? Там активность падает в 3× раза – команда отдыхает.
      </p>
    </div>

  </div>
</section>

<script>
(function() {
  const ctx = document.getElementById('day-of-week-chart');
  if (!ctx) return;

  // Data from Hugo - already parsed as JavaScript arrays
  const labels = {{ $data.day_of_week.labels }};
  const messages = {{ $data.day_of_week.messages }};

  // Ensure data is valid
  if (!Array.isArray(labels) || !Array.isArray(messages)) {
    console.error('Invalid data format for day-of-week chart');
    return;
  }

  // Calculate percentages
  const total = messages.reduce((a, b) => a + b, 0);
  const percentages = messages.map(m => ((m / total) * 100).toFixed(1));

  // Create gradient for bars
  const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, '#F97316');  // Orange start
  gradient.addColorStop(1, '#FDBA74');  // Orange end

  const config = {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Сообщений',
        data: messages,
        backgroundColor: messages.map((m, i) => {
          // Monday and Tuesday - highlight in orange
          if (i === 0 || i === 1) {
            return gradient;
          }
          // Weekend - lighter
          if (i === 5 || i === 6) {
            return 'rgba(100, 116, 139, 0.3)';
          }
          // Weekdays - blue
          return 'rgba(36, 129, 204, 0.6)';
        }),
        borderColor: messages.map((m, i) => {
          if (i === 0 || i === 1) return '#F97316';
          if (i === 5 || i === 6) return '#64748B';
          return '#2481CC';
        }),
        borderWidth: 2,
        borderRadius: 8,
        borderSkipped: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          enabled: true,
          backgroundColor: 'rgba(15, 23, 42, 0.95)',
          titleColor: '#F8FAFC',
          bodyColor: '#94A3B8',
          borderColor: 'rgba(255, 255, 255, 0.1)',
          borderWidth: 1,
          padding: 12,
          displayColors: false,
          titleFont: {
            family: 'Inter',
            size: 14,
            weight: 'bold'
          },
          bodyFont: {
            family: 'JetBrains Mono',
            size: 12
          },
          callbacks: {
            title: function(context) {
              return context[0].label;
            },
            label: function(context) {
              const value = context.parsed.y;
              const percentage = percentages[context.dataIndex];
              return [
                value.toLocaleString('ru-RU') + ' сообщений',
                percentage + '% от всех сообщений'
              ];
            }
          }
        }
      },
      scales: {
        x: {
          grid: {
            display: false
          },
          ticks: {
            color: '#94A3B8',
            font: {
              family: 'Inter',
              size: 13,
              weight: 'bold'
            }
          }
        },
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(148, 163, 184, 0.1)',
            drawBorder: false
          },
          ticks: {
            color: '#64748B',
            font: {
              family: 'JetBrains Mono',
              size: 11
            },
            callback: function(value) {
              return value.toLocaleString('ru-RU');
            }
          }
        }
      },
      animation: {
        duration: 1500,
        easing: 'easeInOutQuart',
        delay: function(context) {
          return context.dataIndex * 100;
        }
      }
    }
  };

  // Create chart
  const chart = new Chart(ctx, config);

  // Animate on scroll
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        chart.update();
        observer.unobserve(entry.target);
      }
    });
  }, { threshold: 0.3 });

  observer.observe(ctx);

})();
</script>
