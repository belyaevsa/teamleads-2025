{{ define "main" }}
{{ $data := .Site.Data.metrics }}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Page Header -->
<section class="relative py-16 px-4">
  <div class="container mx-auto max-w-7xl">
    <div class="text-center mb-12">
      <h1 class="text-5xl md:text-6xl font-heading font-bold text-starlight mb-4">
        <span class="text-gradient-ai">–ö–∞–∂–¥—ã–π –º–µ—Å—è—Ü</span>
      </h1>
      <p class="text-xl text-slate-400 max-w-3xl mx-auto">
        –°–≤–æ—è –∏—Å—Ç–æ—Ä–∏—è
      </p>
    </div>
  </div>
</section>

<!-- Monthly Timeline -->
<section class="relative py-16 px-4 bg-gradient-to-b from-deep-space/50 to-transparent">
  <div class="container mx-auto max-w-7xl">
    <h2 class="text-3xl md:text-4xl font-heading font-bold text-center mb-12 text-starlight">
      üìÖ <span class="text-gradient-management">–ú–µ—Å—è—Ü –∑–∞ –ú–µ—Å—è—Ü–µ–º</span>
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {{ range $data.monthly_narrative }}
      <div class="bento-card p-6
        {{ if .highlight }}border-2 border-management-orange-start/50{{ end }}
        hover:scale-105 transition-all">

        <!-- Month Header -->
        <div class="flex items-center gap-3 mb-4">
          <div class="text-4xl">{{ .emoji }}</div>
          <div class="flex-1">
            <h3 class="font-heading font-bold text-xl text-starlight">{{ .month }}</h3>
            <p class="text-sm text-slate-400">{{ .title }}</p>
          </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <div class="font-data text-2xl font-bold text-telegram-blue">{{ .messages | lang.FormatNumber 0 }}</div>
            <div class="text-slate-400 text-xs">—Å–æ–æ–±—â–µ–Ω–∏–π</div>
          </div>
          <div>
            <div class="font-data text-2xl font-bold text-management-orange-start">{{ .contributors }}</div>
            <div class="text-slate-400 text-xs">—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
          </div>
        </div>

        <!-- Growth Indicator -->
        {{ if .growth }}
        <div class="mb-4">
          <span class="inline-block px-3 py-1 rounded-full text-sm font-bold
            {{ if hasPrefix .growth "+" }}bg-green-500/20 text-green-400
            {{ else }}bg-red-500/20 text-red-400{{ end }}">
            {{ .growth }}
          </span>
        </div>
        {{ end }}

        <!-- Highlight -->
        {{ if .highlight }}
        <div class="mb-4 p-3 bg-management-orange-start/10 border-l-4 border-management-orange-start rounded">
          <p class="text-sm text-management-orange-start font-bold">{{ .highlight }}</p>
        </div>
        {{ end }}

        <!-- Description -->
        <p class="text-sm text-slate-300 mb-4">{{ .description }}</p>

        <!-- Key Events -->
        {{ if .key_events }}
        <div class="border-t border-slate-700 pt-3">
          <p class="text-xs text-slate-400 mb-2 font-bold">–ö–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è:</p>
          <ul class="space-y-1">
            {{ range .key_events }}
            <li class="text-xs text-slate-300">‚Ä¢ {{ . }}</li>
            {{ end }}
          </ul>
        </div>
        {{ end }}

        <!-- Message Length (if available) -->
        {{ if .avg_message_length }}
        <div class="mt-3 text-xs text-slate-400">
          <span class="font-data">üìè</span> –°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞: {{ .avg_message_length }} —Å–∏–º–≤–æ–ª–æ–≤
        </div>
        {{ end }}
      </div>
      {{ end }}
    </div>

    <!-- Year Summary -->
    <div class="mt-12 bento-card p-8 border-l-4 border-ai-purple-start">
      <h3 class="font-heading font-bold text-2xl text-starlight mb-4">
        üéØ –ò—Ç–æ–≥ –≥–æ–¥–∞
      </h3>
      <p class="text-slate-300 text-lg">
        –ì–æ–¥ –Ω–∞—á–∞–ª—Å—è —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã—Ö –ø–µ—Ä–≤—ã—Ö —à–∞–≥–æ–≤, –ø–µ—Ä–µ–∂–∏–ª <strong class="text-management-orange-start">–≤–∑—Ä—ã–≤–Ω–æ–π —Ä–æ—Å—Ç –≤ –º–∞–µ</strong>, –ª–µ—Ç–Ω–∏–π —Å–ø–∞–¥, –º–æ—â–Ω–æ–µ –æ—Å–µ–Ω–Ω–µ–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –∏ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è <strong class="text-telegram-blue">—Ä–µ–∫–æ—Ä–¥–Ω—ã–º –¥–µ–∫–∞–±—Ä–µ–º</strong>!
      </p>
    </div>
  </div>
</section>

<!-- Most Active Days -->
<section class="relative py-16 px-4">
  <div class="container mx-auto max-w-6xl">
    <h2 class="text-3xl md:text-4xl font-heading font-bold text-center mb-4 text-starlight">
      üèÜ <span class="text-gradient-ai">–°–∞–º—ã–µ –ê–∫—Ç–∏–≤–Ω—ã–µ –î–Ω–∏ –ì–æ–¥–∞</span>
    </h2>
    <p class="text-center text-slate-400 mb-12 max-w-2xl mx-auto">
      –¢–æ–ø-5 –¥–Ω–µ–π —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–π
    </p>

    <div class="relative mb-12">
      <canvas id="active-days-chart" style="max-height: 400px;"></canvas>
    </div>

    <!-- Days List -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
      {{ range $data.most_active_days }}
      <div class="bento-card p-6 text-center
        {{ if eq .rank 1 }}border-2 border-yellow-500/50{{ end }}">
        <div class="text-4xl mb-2">
          {{ if eq .rank 1 }}ü•á
          {{ else if eq .rank 2 }}ü•à
          {{ else if eq .rank 3 }}ü•â
          {{ else }}‚≠ê{{ end }}
        </div>
        <div class="font-heading font-bold text-lg text-starlight mb-1">{{ .date }}</div>
        <div class="font-data text-3xl font-bold
          {{ if eq .rank 1 }}text-yellow-400
          {{ else if eq .rank 2 }}text-gray-400
          {{ else if eq .rank 3 }}text-orange-400
          {{ else }}text-blue-400{{ end }} mb-1">
          {{ .messages | lang.FormatNumber 0 }}
        </div>
        <div class="text-slate-400 text-sm">—Å–æ–æ–±—â–µ–Ω–∏–π</div>
      </div>
      {{ end }}
    </div>

    <div class="mt-8 bento-card p-6 border-l-4 border-yellow-500">
      <p class="text-slate-300">
        <strong class="text-yellow-400">21 –¥–µ–∫–∞–±—Ä—è 2025</strong> ‚Äî –∞–±—Å–æ–ª—é—Ç–Ω—ã–π —Ä–µ–∫–æ—Ä–¥ –≥–æ–¥–∞ —Å <strong class="text-management-orange-start">872 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏</strong>! –ü—Ä–µ–¥–Ω–æ–≤–æ–≥–æ–¥–Ω—è—è –Ω–µ–¥–µ–ª—è (20-24 –¥–µ–∫–∞–±—Ä—è) –±—ã–ª–∞ —Å–∞–º–æ–π –∞–∫—Ç–∏–≤–Ω–æ–π –≤ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞.
      </p>
    </div>
  </div>
</section>

<!-- Hourly Activity Heatmap -->
<section class="relative py-16 px-4 bg-gradient-to-b from-deep-space/50 to-transparent">
  <div class="container mx-auto max-w-6xl">
    <h2 class="text-3xl md:text-4xl font-heading font-bold text-center mb-4 text-starlight">
      ‚è∞ <span class="text-gradient-management">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –ß–∞—Å–∞–º</span>
    </h2>
    <p class="text-center text-slate-400 mb-12 max-w-2xl mx-auto">
      –ö–æ–≥–¥–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ –Ω–∞–∏–±–æ–ª–µ–µ –∞–∫—Ç–∏–≤–Ω–æ (Almaty time)
    </p>

    <div class="relative mb-12">
      <canvas id="hourly-chart" style="max-height: 400px;"></canvas>
    </div>

    <!-- Time Periods -->
    <div class="grid md:grid-cols-3 gap-6">
      <div class="bento-card p-6">
        <div class="text-4xl mb-3">üåÖ</div>
        <h3 class="font-heading font-bold text-lg text-starlight mb-2">–£—Ç—Ä–æ (09:00-12:00)</h3>
        <div class="font-data text-3xl text-management-orange-start mb-2">{{ $data.hourly_activity.morning_peak | lang.FormatNumber 0 }}</div>
        <p class="text-slate-400 text-sm">—Å–æ–æ–±—â–µ–Ω–∏–π</p>
        <div class="mt-3 text-xs text-slate-300">
          –ü–∏–∫ –≤ <strong class="text-telegram-blue">11:00</strong> ‚Äî {{ $data.hourly_activity.peak_messages | lang.FormatNumber 0 }} —Å–æ–æ–±—â–µ–Ω–∏–π
        </div>
      </div>
      <div class="bento-card p-6">
        <div class="text-4xl mb-3">‚òÄÔ∏è</div>
        <h3 class="font-heading font-bold text-lg text-starlight mb-2">–î–µ–Ω—å (12:00-18:00)</h3>
        <div class="font-data text-3xl text-telegram-blue mb-2">{{ $data.hourly_activity.afternoon | lang.FormatNumber 0 }}</div>
        <p class="text-slate-400 text-sm">—Å–æ–æ–±—â–µ–Ω–∏–π</p>
        <div class="mt-3 text-xs text-slate-300">
          –û—Å–Ω–æ–≤–Ω–∞—è —Ä–∞–±–æ—á–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        </div>
      </div>
      <div class="bento-card p-6">
        <div class="text-4xl mb-3">üåô</div>
        <h3 class="font-heading font-bold text-lg text-starlight mb-2">–í–µ—á–µ—Ä (20:00-23:00)</h3>
        <div class="font-data text-3xl text-ai-purple-start mb-2">{{ $data.hourly_activity.evening | lang.FormatNumber 0 }}</div>
        <p class="text-slate-400 text-sm">—Å–æ–æ–±—â–µ–Ω–∏–π</p>
        <div class="mt-3 text-xs text-slate-300">
          –í–µ—á–µ—Ä–Ω–∏–µ –¥–∏—Å–∫—É—Å—Å–∏–∏
        </div>
      </div>
    </div>

    <div class="mt-8 bento-card p-6 border-l-4 border-telegram-blue">
      <p class="text-slate-300">
        <span class="text-2xl mr-2">üìä</span>
        –°–æ–æ–±—â–µ—Å—Ç–≤–æ –∂–∏–≤–µ—Ç –ø–æ <strong class="text-telegram-blue">–æ—Ñ–∏—Å–Ω–æ–º—É —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é</strong> (9:00-18:00). –ü–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ <strong class="text-management-orange-start">11:00</strong> ‚Äî –ø—Ä–µ–¥–æ–±–µ–¥–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è, –∫–æ–≥–¥–∞ –≤—Å–µ —É–∂–µ –ø—Ä–æ—Å–Ω—É–ª–∏—Å—å –∏ –≥–æ—Ç–æ–≤—ã –∫ –¥–∏—Å–∫—É—Å—Å–∏—è–º.
      </p>
    </div>
  </div>
</section>

<!-- Events Summary -->
<section class="relative py-16 px-4">
  <div class="container mx-auto max-w-6xl">
    <h2 class="text-3xl md:text-4xl font-heading font-bold text-center mb-4 text-starlight">
      üéâ <span class="text-gradient-ai">–°–æ–±—ã—Ç–∏—è –ì–æ–¥–∞</span>
    </h2>
    <p class="text-center text-slate-400 mb-12 max-w-2xl mx-auto">
      {{ $data.events_summary.total_events }} —Å–æ–±—ã—Ç–∏—è –≤ —Ç–µ—á–µ–Ω–∏–µ –≥–æ–¥–∞
    </p>

    <div class="grid md:grid-cols-2 gap-8 mb-8">
      <div class="bento-card p-8 text-center">
        <div class="text-5xl mb-4">üé™</div>
        <div class="font-data text-6xl font-bold text-management-orange-start mb-2">{{ $data.events_summary.total_events }}</div>
        <div class="text-slate-400 text-lg mb-4">–í—Å–µ–≥–æ —Å–æ–±—ã—Ç–∏–π</div>
        <div class="text-sm text-slate-300">
          –° {{ $data.events_summary.first_event }} –ø–æ {{ $data.events_summary.last_event }}
        </div>
      </div>

      <div class="bento-card p-8">
        <h3 class="font-heading font-bold text-xl text-starlight mb-4">–¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π:</h3>
        <ul class="space-y-3">
          {{ range $data.events_summary.types }}
          <li class="flex items-start gap-3">
            <span class="text-telegram-blue text-xl">‚Ä¢</span>
            <span class="text-slate-300">{{ . }}</span>
          </li>
          {{ end }}
        </ul>
      </div>
    </div>

    <div class="bento-card p-6 border-l-4 border-ai-purple-start">
      <p class="text-slate-300">
        –í 2025 –≥–æ–¥—É —Å–æ–æ–±—â–µ—Å—Ç–≤–æ –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ –æ–Ω–ª–∞–π–Ω-–æ–±—Å—É–∂–¥–µ–Ω–∏—è–º–∏. <strong class="text-ai-purple-start">{{ $data.events_summary.total_events }} —Å–æ–±—ã—Ç–∏—è</strong> –≤–∫–ª—é—á–∞–ª–∏ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—Å—Ç—Ä–µ—á–∏ <strong class="text-telegram-blue">nullptr.party</strong>, —Ö–∞–∫–∞—Ç–æ–Ω—ã, AI-–º–∏—Ç–∞–ø—ã –∏ –æ–±—Å—É–∂–¥–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.
      </p>
    </div>
  </div>
</section>

<!-- Charts Scripts -->
<script>
// Most Active Days Chart
(function() {
  const ctx = document.getElementById('active-days-chart');
  if (!ctx) return;

  const days = {{ range $data.most_active_days }}{{ .date | jsonify }},{{ end }};
  const messages = {{ range $data.most_active_days }}{{ .messages }},{{ end }};
  const colors = ['#EAB308', '#9CA3AF', '#F97316', '#3B82F6', '#8B5CF6'];

  const config = {
    type: 'bar',
    data: {
      labels: days,
      datasets: [{
        label: '–°–æ–æ–±—â–µ–Ω–∏–π',
        data: messages,
        backgroundColor: colors,
        borderColor: colors.map(c => c),
        borderWidth: 2,
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 42, 0.95)',
          titleColor: '#F8FAFC',
          bodyColor: '#94A3B8',
          borderColor: 'rgba(255, 255, 255, 0.1)',
          borderWidth: 1,
          padding: 12,
          displayColors: false,
          callbacks: {
            label: function(context) {
              return context.parsed.y.toLocaleString('ru-RU') + ' —Å–æ–æ–±—â–µ–Ω–∏–π';
            }
          }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { color: '#94A3B8', font: { family: 'Inter', size: 12, weight: 'bold' } }
        },
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(148, 163, 184, 0.1)' },
          ticks: {
            color: '#64748B',
            font: { family: 'JetBrains Mono', size: 11 },
            callback: function(value) {
              return value.toLocaleString('ru-RU');
            }
          }
        }
      },
      animation: {
        duration: 1500,
        easing: 'easeInOutQuart'
      }
    }
  };

  new Chart(ctx, config);
})();

// Hourly Activity Chart
(function() {
  const ctx = document.getElementById('hourly-chart');
  if (!ctx) return;

  const hours = {{ $data.hourly_activity.labels }};
  const messages = {{ $data.hourly_activity.messages }};

  // Create gradient
  const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, 'rgba(36, 129, 204, 0.5)');
  gradient.addColorStop(1, 'rgba(36, 129, 204, 0.0)');

  const config = {
    type: 'line',
    data: {
      labels: hours,
      datasets: [{
        label: '–°–æ–æ–±—â–µ–Ω–∏–π',
        data: messages,
        fill: true,
        backgroundColor: gradient,
        borderColor: '#2481CC',
        borderWidth: 3,
        tension: 0.4,
        pointRadius: 4,
        pointBackgroundColor: '#2481CC',
        pointBorderColor: 'rgba(255, 255, 255, 0.8)',
        pointBorderWidth: 2,
        pointHoverRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 42, 0.95)',
          titleColor: '#F8FAFC',
          bodyColor: '#94A3B8',
          borderColor: 'rgba(255, 255, 255, 0.1)',
          borderWidth: 1,
          padding: 12,
          displayColors: false,
          callbacks: {
            title: function(context) {
              return context[0].label + ':00';
            },
            label: function(context) {
              return context.parsed.y.toLocaleString('ru-RU') + ' —Å–æ–æ–±—â–µ–Ω–∏–π';
            }
          }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: {
            color: '#94A3B8',
            font: { family: 'Inter', size: 11 },
            maxRotation: 0,
            callback: function(value, index) {
              return index % 3 === 0 ? this.getLabelForValue(value) + ':00' : '';
            }
          }
        },
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(148, 163, 184, 0.1)' },
          ticks: {
            color: '#64748B',
            font: { family: 'JetBrains Mono', size: 11 },
            callback: function(value) {
              return value.toLocaleString('ru-RU');
            }
          }
        }
      },
      animation: {
        duration: 2000,
        easing: 'easeInOutQuart'
      }
    }
  };

  new Chart(ctx, config);
})();
</script>

{{ end }}
